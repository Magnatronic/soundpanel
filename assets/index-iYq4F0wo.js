(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(a){if(a.ep)return;a.ep=!0;const s=t(a);fetch(a.href,s)}})();class _{constructor(e){this.config=e,this.audioContext=null,this.analyser=null,this.dataArray=null,this.stream=null,this.fftSize=2048,this.smoothing=e.smoothing||.8}async init(){this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.fftSize,this.analyser.smoothingTimeConstant=this.smoothing,this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.dataArray=new Uint8Array(this.analyser.frequencyBinCount)}getFrequencyData(){return this.analyser.getByteFrequencyData(this.dataArray),this.dataArray}getVolume(){this.analyser.getByteTimeDomainData(this.dataArray);let e=0;for(let t=0;t<this.dataArray.length;t++){let i=this.dataArray[t]-128;e+=i*i}return Math.sqrt(e/this.dataArray.length)}}class U{constructor(e){this.analyser=e,this.dataArray=new Uint8Array(e.frequencyBinCount)}getBands(){this.analyser.getByteFrequencyData(this.dataArray);const e=this.average(0,10),t=this.average(10,100),i=this.average(100,200);return{bass:e,mid:t,treble:i}}average(e,t){let i=0;for(let a=e;a<t;a++)i+=this.dataArray[a];return i/(t-e)}}class W{constructor(e=30){this.threshold=e,this.lastVolume=0,this.lastBeat=0,this.cooldown=200}detect(e,t=performance.now()){return e>this.threshold&&t-this.lastBeat>this.cooldown?(this.lastBeat=t,!0):(this.lastVolume=e,!1)}}function E(o){const{width:e,height:t}=o.getBoundingClientRect();return o.width!==e||o.height!==t?(o.width=e,o.height=t,!0):!1}class A{constructor(e,t,i){this.canvas=e,this.ctx=e.getContext("2d"),this.audioData=t,this.config=i}render(){}resize(){}}function p(o,e,t){return`hsl(${o}, ${e}%, ${t}%)`}class D extends A{render(e){const{ctx:t,canvas:i,config:a}=this;t.globalAlpha=.18,t.fillStyle="#000",t.fillRect(0,0,i.width,i.height),t.globalAlpha=1;const s=6,n=Math.floor(e.length/s),c=Math.max(8,Math.floor(i.width/n)),r=a.sensitivity||1;for(let d=0;d<n;d++){let h=0;for(let M=0;M<s;M++)h+=e[d*s+M];let m=(h/s-128)*2*r;m=Math.max(0,m);const w=i.height*.04,l=m/255,u=Math.max(l*i.height,w),f=d/n*240;t.save(),t.globalAlpha=.7+.3*Math.sin(performance.now()/400+d),t.fillStyle=p(f,80,50),t.fillRect(d*c,i.height-u,c-2,u),t.restore()}}}class H extends A{render(e){const{ctx:t,canvas:i,config:a}=this;t.globalAlpha=.13,t.fillStyle="#000",t.fillRect(0,0,i.width,i.height),t.globalAlpha=1;const s=i.width/2,n=i.height/2,c=Math.min(s,n)*1.8,r=64,d=Math.floor(e.length/r);this.prevRadii||(this.prevRadii=new Array(r).fill(c*.2));for(let h=0;h<r;h++){const m=(e[h*d]-128)*2*(a.sensitivity||1),w=c*.06;let l=Math.max(m/255*c,w);l=this.prevRadii[h]=this.prevRadii[h]*.7+l*.3;const u=h/r*2*Math.PI,f=h/r*240+l*.2;t.save(),t.translate(s,n),t.rotate(u),t.beginPath(),t.arc(0,0,l,-Math.PI/r,Math.PI/r),t.strokeStyle=p(f%360,80,60),t.lineWidth=6+4*Math.sin(performance.now()/600+h),t.shadowBlur=18,t.shadowColor=t.strokeStyle,t.stroke(),t.restore()}}}class N{constructor(e,t,i,a,s,n){this.x=e,this.y=t,this.vx=i,this.vy=a,this.color=s,this.life=1,this.size=n}update(){this.x+=this.vx,this.y+=this.vy,this.vx*=.99,this.vy*=.99,this.life-=.008}}class $ extends A{constructor(e,t,i){super(e,t,i),this.particles=[]}render(e){const{ctx:t,canvas:i,config:a}=this;t.save(),t.globalAlpha=.18,t.fillStyle="#000",t.fillRect(0,0,i.width,i.height),t.restore();const s=e.reduce((l,u)=>l+Math.abs(u-128),0)/e.length,n=i.width*i.height,r=Math.floor(1200*(n/(1280*720))),d=Math.floor((10+s*(a.sensitivity||1)*.2)*(n/(1280*720))),h=i.width/2,m=i.height/2,w=Math.min(i.width,i.height)*.18;for(let l=0;l<d;l++){const u=Math.random()*2*Math.PI,f=Math.random()*w,M=h+Math.cos(u)*f,F=m+Math.sin(u)*f,R=(1+Math.random()*1.5+s*.02)*(Math.min(i.width,i.height)/720),T=Math.cos(u)*R,k=Math.sin(u)*R,V=Math.floor(Math.random()*e.length),q=e[V];let z;a.theme==="light"?z=p((q*2+s*2)%360,70,45):z=p((q*2+s*2)%360,90,60);const O=.7+(q-128)*.02*(Math.min(i.width,i.height)/720);this.particles.push(new N(M,F,T,k,z,O))}this.particles=this.particles.filter(l=>l.life>0),this.particles.length>r&&this.particles.splice(0,this.particles.length-r);for(const l of this.particles)l.update(),t.save(),t.globalAlpha=l.life*.8+.2,t.fillStyle=l.color,t.beginPath(),t.arc(l.x,l.y,Math.max(1,l.size),0,2*Math.PI),t.fill(),t.restore()}}class X extends A{render(e){const{ctx:t,canvas:i,config:a}=this;t.globalAlpha=.18,t.fillStyle="#000",t.fillRect(0,0,i.width,i.height),t.globalAlpha=1,t.save(),t.translate(0,i.height/2),t.beginPath();for(let s=0;s<e.length;s++){const n=s/e.length*i.width,c=i.height*.03;let r=(e[s]-128)*(i.height/256)*(a.sensitivity||1);Math.abs(r)<c&&(r=r<0?-c:c);const d=s/e.length*360+(e[s]-128)*1.5;t.strokeStyle=p(d%360,80,60),s===0||(t.lineTo(n,r),t.stroke(),t.beginPath()),t.moveTo(n,r)}t.restore()}}class Y extends A{constructor(e,t,i){super(e,t,i),this.balls=Array.from({length:8},(a,s)=>({x:Math.random()*e.width,y:Math.random()*e.height,r:40+Math.random()*40,vx:(Math.random()-.5)*2,vy:(Math.random()-.5)*2}))}render(e){const{ctx:t,canvas:i,config:a}=this;t.globalAlpha=.13,t.fillStyle="#000",t.fillRect(0,0,i.width,i.height),t.globalAlpha=1,(!this.balls||this.balls.length<18)&&(this.balls=Array.from({length:18},(s,n)=>({x:Math.random()*i.width,y:Math.random()*i.height,r:40+Math.random()*40,vx:(Math.random()-.5)*2,vy:(Math.random()-.5)*2})));for(let s=0;s<this.balls.length;s++){const n=this.balls[s];n.x+=n.vx*1.2,n.y+=n.vy*1.2,n.vx+=(Math.random()-.5)*.1,n.vy+=(Math.random()-.5)*.1,n.vx*=.98,n.vy*=.98,(n.x<n.r||n.x>i.width-n.r)&&(n.vx*=-1),(n.y<n.r||n.y>i.height-n.r)&&(n.vy*=-1);const c=Math.floor(s/this.balls.length*e.length),r=30;n.r=Math.max(r,40+(e[c]-128)*2.5*(a.sensitivity||1))}for(let s=0;s<this.balls.length;s++){const n=this.balls[s];t.save(),t.globalAlpha=.45,t.beginPath(),t.arc(n.x,n.y,Math.abs(n.r),0,2*Math.PI),t.fillStyle=p(200+s*20+n.r*2,80,60),t.shadowBlur=30,t.shadowColor=t.fillStyle,t.fill(),t.restore()}}}fetch("/soundpanel/TitleBar.html").then(o=>o.text()).then(o=>{const e=document.createElement("div");e.innerHTML=o;const t=e.querySelector("style");t&&document.head.appendChild(t);const i=e.querySelector("#titleBar"),a=e.querySelector("#settingsModal");if(i){const s=document.getElementById("titleBar");s?s.replaceWith(i):document.body.prepend(i)}if(a){const s=document.getElementById("settingsModal");s?s.replaceWith(a):document.body.appendChild(a)}j()});function j(){g(I),document.getElementById("mode-frequencyBars").onclick=()=>{y("frequencyBars"),g("frequencyBars")},document.getElementById("mode-radialBurst").onclick=()=>{y("radialBurst"),g("radialBurst")},document.getElementById("mode-particleSystem").onclick=()=>{y("particleSystem"),g("particleSystem")},document.getElementById("mode-waveform").onclick=()=>{y("waveform"),g("waveform")},document.getElementById("mode-fluidSimulation").onclick=()=>{y("fluidSimulation"),g("fluidSimulation")},document.getElementById("fullscreenBtn").onclick=()=>{const o=document.getElementById("visualizer");document.fullscreenElement?document.exitFullscreen():o&&o.requestFullscreen&&o.requestFullscreen()},document.getElementById("pauseBtn").onclick=()=>{S=!S,document.getElementById("pauseBtn").textContent=S?"play_arrow":"pause"},document.getElementById("settingsBtn").onclick=()=>{document.getElementById("settingsModal").classList.remove("hidden")},document.getElementById("closeSettings").onclick=()=>{document.getElementById("settingsModal").classList.add("hidden")},document.getElementById("sensitivityRange").oninput=o=>{b.sensitivity=parseFloat(o.target.value)},document.getElementById("colorThemeSelect").onchange=o=>{b.colorTheme=o.target.value}}const b={sensitivity:1,colorTheme:"rainbow",smoothing:.8,particleCount:1e3,fadeSpeed:.05,minThreshold:10,maxThreshold:200},v=document.getElementById("visualizer");let B,x,I="frequencyBars",S=!1;const L={frequencyBars:D,radialBurst:H,particleSystem:$,waveform:X,fluidSimulation:Y};function y(o){L[o]&&(I=o,x=new L[I](v,[],b))}async function G(){B=new _(b),await B.init(),new U(B.analyser),new W(b.minThreshold),y(I),window.addEventListener("resize",C),E(v),P()}function C(){E(v),x&&typeof x.resize=="function"&&x.resize()}window.addEventListener("resize",C);v.addEventListener("fullscreenchange",C);E(v);function P(){if(S){requestAnimationFrame(P);return}E(v);const o=B.getFrequencyData(),e=B.getVolume();window.DEBUG_AUDIO!==!1&&(!window._lastLog||performance.now()-window._lastLog>500)&&(console.log("Volume:",e,"First 8 freq bins:",Array.from(o).slice(0,8)),window._lastLog=performance.now()),x.render(o),requestAnimationFrame(P)}function g(o){document.querySelectorAll(".mode-icon").forEach(t=>t.classList.remove("active"));const e=document.getElementById("mode-"+o);e&&e.classList.add("active")}G();
